# 20180426 渲染管线的流程



----------

原文：https://blog.csdn.net/limu693992297/article/details/52605479

关于渲染管线将什么呢?无非就是在OpenGL的管道当中各个部分的功能以及如何在管道当中形成了我们想要的最终的一幅图.(像素).而管线当中的操作可分为以下几个部分:

##  阶段1. **指定几何对象.**

​      如:点 线 三角形.等一些几何图元..OpenGL绘制几何图元的方法有以下三种:
      <1> 一次一个顶点.即使用glBegin()  glVertex() glEnd() 指定几何对象.
      <2> 使用顶点数组..如glDrawArrays.glDrawElements.等.一次性的绘制大量图元.
     上面这两种模式则是立即模式.即指定完图元之后会被立即渲染.即将所有数据发往渲染管线后立即被渲染.
      <3>显示列表模式.它存储于OpenGL服务端 (接收OpenGL命令的一端.) glNewList glEndList glCallList .
    

## 阶段2   **顶点处理操作:**

​         不管以上的几何对象是如何指定的,所有的几何数据都将会经过这个阶段,这个阶段负责的则是逐个顶点的操作.
         在这个阶段能做的工作则是:

         1. 顶点变换...根据模型视图和投影矩阵变换
         2. 光照计算 法线变换(法线矩阵 是模型矩阵的左上角3*3的逆矩阵)和法线规格化 
         3. 纹理坐标变换.(纹理矩阵)
                  4.材质状态 纹理坐标生成?
                  而最重要的则是变换以及光照. 每个顶点在这个阶段分别是单独处理的.
                  这个阶段所接收到的数据则是每个顶点的属性特征..输出则是变换后的顶点数据.


## 阶段3  **图元组装**

​         在顶点处理之后,顶点的全部属性都已经被确定 在这个阶段顶点将会根据应用程序送往的图元规则.
GL_POINTS GL_TRIANGLES 等 将会被组装成图元


阶段4 **图元处理(裁剪 消隐)**
         <1>这个步骤第一个所做的应当是裁剪操作..会将图元与用户定义的裁剪平面 即glClipPlane 和模型投影矩阵所建立的视景比较. 这将会裁剪且丢弃位于视景和裁剪平面外部的图元.不在予以处理.
        <2> 其次.若是采用透视投影 那么.将会对每个顶点的x,y z坐标分别除以w. 
        <3>紧接着 则是由视口变换将顶点坐标变换至窗口坐标.
        <4> 执行消隐操作 

## 阶段5  **栅格化操作**

​        <1>由图元处理传递过来的图元数据.在此将会被分解成更小的单元并对应帧缓冲区的各个像素.这些单元被称之为 片元. 一个片元可能包含窗口左边 深度 颜色 纹理坐标等属性.
         <2> 片元的属性则是图元上顶点数据等经过插值而确定的..这里生成的片元将会包含主颜色和次颜色.
           glShadeMode() 函数的作用将会这里体现.即使用插值(平滑着色) 或者使用最后一个顶点颜色(平面着色)
         <3> 点宽 线宽.多边形模式,正面背面等一些特征也将是这阶段发生作用.
          <4> 反走样也是这个阶段起作用.

##  阶段6 **片元处理**

​         <1>上纹理 通过纹理坐标取得纹理内存中相对应的颜色
         <2> 雾化 通过片元距离当前视点位置修改颜色.
         <3> 颜色汇总..(这个与混合完全不同概念.将(纹理,主定义的颜色,雾化的颜色,次颜色光照阶段计算的颜色)汇总一起.
        

## 阶段7  **逐个片元的操作**

​         <1> 所有的一些测试 像素所有权 剪切(glScissor) Alpha测试(glAlphaFunc) 模版测试(glStencilFunc)
          深度测试 (glDephtFunc) 混合(glBlendFunc) 
         这些操作将会最后影响其在帧缓冲区的颜色值.

## 阶段8  **帧缓冲操作**

​        <1>这个阶段执行帧缓冲的写入等操作等..最后产生了显示出来的像素.
         glColorMask glStrncilMask glDepthMask glClearDepht glClearStencil glClearColor 等.将在这个阶段影响写入的值.




以上只是讨论OpenGL 图元绘制的基本过程 那么基于像素图像绘制.几乎形同之上..只是在光栅化处理前的操作不一样.即经过像素解码 像素传输.栅格化 最后形成片元...片元之后的处理完全一样..


因此 在着色器编程领域..你将可实现
    **Vertex Shader 替换 顶点处理阶段**
    **Fragment Shader 替换 片元处理阶段**
    **Geometry Shader 替换 图元组装阶段..**


因为这三个阶段所决定都是最重要效果的阶段..对于这些的可编程将带来非常大的好处以及可控制的渲染!!


——————————————————————————————————————————————————
1、顶点变幻。（顶点着色器－Vertex Shader）


　　顶点依次通过模型视图矩阵（ModelView）处理，生成变幻后的顶点。


2、图元装配。


　　a）图元装配。


　　b）裁剪。（CCV原理）


　　c）透视除法。


3、视口变换。


4、光栅化。


　　顶点信息转换为像素信息，包含：片段（Fragment）坐标、纹理坐标、片段颜色。


5、片段处理。（片段着色器－Fragment Shader）


　　决定片段最终颜色。


6、片段测试


7、进入Framebuffer



红色部分是固定管线和可编程管线不同的地方。

